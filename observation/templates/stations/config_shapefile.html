{% extends "base.html" %}

{% load static %}


{% block extra_css %}

{% endblock extra_css %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin="">
  </script>
   <!------->
<!-- Leaflet.draw CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@0.4.2/dist/leaflet.draw.css" />

<!-- Leaflet.draw JavaScript -->
<script src="https://unpkg.com/leaflet-draw@0.4.2/dist/leaflet.draw.js"></script>
   <!------->

  <script src="https://www.unpkg.com/spin@0.0.1/dist/spin.js"></script>
  <script src="https://unpkg.com/leaflet-spin@1.1.1/leaflet.spin.js"></script>
<style type="text/css">
    #map { height: 600px; }
</style>

<h5>Téléchargement d'un Shapefile</h5>
    
    <!-- Form to upload shapefile -->
    <form id="shapefileForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <label for="shapefile">Upload Shapefile:</label>
        <input type="file" name="shapefile" accept=".zip" id="shapefile">
        <button type="submit">Upload</button>
    </form>
<div id="map"></div>
    //TODO put the script in (static/js/map_script.js)

  <script type="text/javascript"> 
    var map = L.map('map').setView([28, -8], 5);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

// add plugin Leaflet.draw
var drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  var drawControl = new L.Control.Draw({
    draw: {
      polygon: true,
      polyline: true,
      rectangle: true,
      circle: true,
      marker: true
    },
    edit: {
      featureGroup: drawnItems,
      remove: true
    }
  });

  map.addControl(drawControl);
 
 // Handle shapefile upload form submission
 document.getElementById('shapefileForm').addEventListener('submit', function (e) {
    e.preventDefault();

    var formData = new FormData(this);

    fetch('/configzone/uploadShapefile/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value
        }
    })
    .then(response => response.json())
    .then(data => {
        /* // Process the uploaded shapefile data and display it on the map
                // Assuming the GeoJSON is in data.geojson
                var geojson = JSON.parse(data.geojson);

                // Add GeoJSON layer to the map
                L.geoJSON(geojson).addTo(map); */

        if ('message' in data) {
            // Error occurred, display alert
            alert(data.message);
        } else if ('geojson' in data) {
            // Process the uploaded shapefile data and display it on the map
            var geojson = JSON.parse(data.geojson);

            // Add GeoJSON layer to the map
            //L.geoJSON(geojson).addTo(map);
            L.geoJSON(geojson, {
            onEachFeature: function (feature, layer) {
            // Access features
            var properties = feature.properties;
            //console.log("Properties:", properties);

            // Add popup on map
            //layer.bindPopup("<b>Province:</b> " + properties.province + "<br><b>Id:</b> " + properties.id);
            layer.bindPopup(Object.entries(properties).map(([key, value]) => `<b>${key}:</b> ${value}`).join('<br>'));
            
            // Accédez aux coordonnées des points qui constituent chaque polygone
            var coordinates = feature.geometry.coordinates;
            console.log("Coordinates:", coordinates);

            // Vous pouvez également accéder aux géométries directement
            var geometry = feature.geometry;
            console.log("Geometry:", geometry);
        }
  }).addTo(map);

            //get MetaData
            
        } else {
            // Unexpected response format, display alert
            alert('Unexpected response format');
        }
    })
    .catch(error => {
        //console.error('Error:', error);
        //alert(data.message);
    });
});



   


  </script>
{% endblock content %}
