{% extends "base.html" %}

{% block content %}
    <title>Import CSV - Données Climatiques Mensuelles</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .csv-import-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }
        .file-upload-area {
            border: 2px dashed #dbdbdb;
            border-radius: 6px;
            padding: 40px;
            text-align: center;
            transition: border-color 0.3s;
        }
        .file-upload-area:hover {
            border-color: #3273dc;
        }
        .file-upload-area.dragover {
            border-color: #48c774;
            background-color: #f0fff4;
        }
        .recent-imports {
            margin-top: 40px;
        }
        .status-success {
            color: #48c774;
        }
        .status-error {
            color: #f14668;
        }
        .help-text {
            font-size: 0.875rem;
            color: #7a7a7a;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="csv-import-container">
        <div class="content">
            <h1 class="title is-2">
                <i class="fas fa-upload"></i>
                Import de données climatiques mensuelles CSV
            </h1>
            
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                <div class="notification {% if message.tags == 'error' %}is-danger{% elif message.tags == 'success' %}is-success{% else %}is-info{% endif %}">
                    <button class="delete"></button>
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
            
            <!-- Formulaire d'import -->
            <div class="box">
                <h2 class="subtitle is-4">Paramètres d'import</h2>
                
                <form method="post" enctype="multipart/form-data" id="csv-import-form">
                    {% csrf_token %}
                    
                    <div class="columns">
                        <div class="column">
                            <div class="field">
                                <label class="label">Année</label>
                                <div class="control">
                                    <input class="input" type="number" name="year" 
                                           value="{{ form_data.year }}" min="1900" max="2100" required>
                                </div>
                                <p class="help-text">Année des données</p>
                            </div>
                        </div>
                        
                        <div class="column">
                            <div class="field">
                                <label class="label">Mois</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select name="month" required>
                                            {% for i in "123456789012"|make_list %}
                                                {% with month_num=forloop.counter %}
                                                <option value="{{ month_num }}" {% if month_num == form_data.month %}selected{% endif %}>
                                                    {{ month_num }} - {% if month_num == 1 %}Janvier{% elif month_num == 2 %}Février{% elif month_num == 3 %}Mars{% elif month_num == 4 %}Avril{% elif month_num == 5 %}Mai{% elif month_num == 6 %}Juin{% elif month_num == 7 %}Juillet{% elif month_num == 8 %}Août{% elif month_num == 9 %}Septembre{% elif month_num == 10 %}Octobre{% elif month_num == 11 %}Novembre{% else %}Décembre{% endif %}
                                                </option>
                                                {% endwith %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <p class="help-text">Mois des données (1-12)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="field">
                        <label class="label">Source des données</label>
                        <div class="control">
                            <input class="input" type="text" name="source" 
                                   value="{{ form_data.source }}" placeholder="Ex: MeteoFrance, NOAA, etc." required>
                        </div>
                        <p class="help-text">Origine des données (sera utilisée si non spécifiée dans le CSV)</p>
                    </div>
                    
                    <!-- Zone de téléchargement de fichier -->
                    <div class="field">
                        <label class="label">Fichier CSV</label>
                        <div class="file-upload-area" id="file-upload-area">
                            <div class="file-upload-content">
                                <i class="fas fa-cloud-upload-alt fa-3x has-text-grey-light"></i>
                                <p class="has-text-grey-dark">
                                    <strong>Cliquez pour sélectionner</strong> ou glissez-déposez votre fichier CSV ici
                                </p>
                                <p class="help-text">
                                    Le fichier doit contenir les colonnes : <strong>lat, lon, value, parameter, name</strong><br>
                                    Colonne optionnelle : <strong>source, station</strong>
                                </p>
                            </div>
                            <input type="file" name="csv_file" id="csv-file-input" accept=".csv" required style="display: none;">
                        </div>
                        <div id="file-info" style="display: none;" class="mt-3">
                            <div class="notification is-info is-light">
                                <strong>Fichier sélectionné :</strong> <span id="file-name"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="field">
                        <div class="control">
                            <button type="submit" class="button is-primary is-large">
                                <span class="icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span>Importer les données</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Format du CSV -->
            <div class="box">
                <h3 class="subtitle is-5">Format du fichier CSV requis</h3>
                <div class="content">
                    <p>Votre fichier CSV doit contenir les colonnes suivantes :</p>
                    
                    <div class="table-container">
                        <table class="table is-striped is-hoverable">
                            <thead>
                                <tr>
                                    <th>Colonne</th>
                                    <th>Obligatoire</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Exemple</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>lat</strong></td>
                                    <td><span class="tag is-danger">Oui</span></td>
                                    <td>Nombre</td>
                                    <td>Latitude du point d’observation</td>
                                    <td>12.3700</td>
                                </tr>
                                <tr>
                                    <td><strong>lon</strong></td>
                                    <td><span class="tag is-danger">Oui</span></td>
                                    <td>Nombre</td>
                                    <td>Longitude du point d’observation</td>
                                    <td>-1.5197</td>
                                </tr>
                                <tr>
                                    <td><strong>value</strong></td>
                                    <td><span class="tag is-danger">Oui</span></td>
                                    <td>Nombre</td>
                                    <td>Valeur observée</td>
                                    <td>28.4</td>
                                </tr>
                                <tr>
                                    <td><strong>parameter</strong></td>
                                    <td><span class="tag is-danger">Oui</span></td>
                                    <td>Texte</td>
                                    <td>Paramètre mesuré (ex : t2m, tp,...)</td>
                                    <td>t2m</td>
                                </tr>
                                <tr>
                                    <td><strong>name</strong></td>
                                    <td><span class="tag is-danger">Oui</span></td>
                                    <td>Texte</td>
                                    <td>Nom du paramètre</td>
                                    <td>surface_air_temperature</td>
                                </tr>
                                <tr>
                                    <td><strong>Station</strong></td>
                                    <td><span class="tag is-warning">Non</span></td>
                                    <td>Texte</td>
                                    <td>Nom du site ou de la localité</td>
                                    <td>Ouagadougou</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="message is-info">
                        <div class="message-body">
                            <strong>Note :</strong> Si les colonnes optionnelles ne sont pas présentes, 
                            les valeurs des champs du formulaire seront utilisées par défaut.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Imports récents -->
            {% if recent_imports %}
            <div class="box recent-imports">
                <h3 class="subtitle is-5">Imports récents</h3>
                <div class="table-container">
                    <table class="table is-striped is-hoverable is-fullwidth">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Source</th>
                                <th>Période</th>
                                <th>Statut</th>
                                <th>Succès</th>
                                <th>Erreurs</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for import in recent_imports %}
                            <tr>
                                <td>{{ import.created_at|date:"d/m/Y H:i" }}</td>
                                <td>{{ import.source }}</td>
                                <td>{{ import.year }}/{{ import.month }}</td>
                                <td>
                                    {% if import.processed %}
                                        {% if import.error_count == 0 %}
                                            <span class="tag is-success">Réussi</span>
                                        {% else %}
                                            <span class="tag is-warning">Avec erreurs</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="tag is-info">En cours</span>
                                    {% endif %}
                                </td>
                                <td class="status-success">{{ import.success_count }}</td>
                                <td class="status-error">{{ import.error_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Gestion du drag & drop et sélection fichier (idem version décennale)
        document.addEventListener('DOMContentLoaded', function() {
            const fileUploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('csv-file-input');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');

            fileUploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileName.textContent = this.files[0].name;
                    fileInfo.style.display = 'block';
                }
            });

            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.csv')) {
                        const dt = new DataTransfer();
                        dt.items.add(file);
                        fileInput.files = dt.files;

                        fileName.textContent = file.name;
                        fileInfo.style.display = 'block';
                    } else {
                        alert('Veuillez sélectionner un fichier CSV');
                    }
                }
            });

            document.querySelectorAll('.notification .delete').forEach(btn =>
                btn.addEventListener('click', function() {
                    this.parentElement.style.display = 'none';
                })
            );
        });
    </script>
{% endblock %}
