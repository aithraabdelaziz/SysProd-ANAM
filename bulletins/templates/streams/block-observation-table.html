{% load dict_extras %}
{% load static %}
{% load custom_tags %}
<style type="text/css">
    .station-separator {
      border-top: 3px solid #000; /* ou autre couleur selon ton design */
    }
</style>
<div class="block-forecast-table">
    {% if self.title %}
        <span style="{{ctx.style.title }}">{{ self.title }} {% if ctx.obst_periode %} : <span style="{{ctx.style.title }}"> {{ ctx.obst_periode }}</span>{% endif %}</span>
    {% endif %}
    {% if ctx.obst_sorted_heures|length > 1 %}
        <table class="forecast-table" style="{{ctx.style.table }}">
            <thead>
                <tr>
                    <th rowspan="2" >Station</th>
                    <th rowspan="2">Param√®tre</th>
                    {% for jour,ech in ctx.obst_jours_obs.items %}
                        <th colspan="{{ ech|length }}"> {{ jour }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    {% for jour,ech in ctx.obst_jours_obs.items %}
                        {% for e,name_ech in ech.items %}
                            <th> {{ name_ech }}</th>
                        {% endfor %}
                    {% endfor %}
                </tr>     
            </thead>

            {% if modify_text %}  
                <form method="post" action="{% url 'bulletins:save_obsTable' pk=object.id  date_bult=object.established_date|date:'Y-m-d' %}" class="bg-light p-4 rounded shadow-sm">
                    {% csrf_token %}
                <tbody>
                  {% for zone in ctx.obst_stations %}
                    {% for parametre in ctx.obst_parameters %}
                      <tr class="{% if forloop.first %}station-separator{% endif %}">
                        {% if forloop.first %}
                          <th rowspan="{{ ctx.obst_parameters|length }}">{{ zone.name }}</th>
                        {% endif %}
                        <td class="parameter-col">{{ parametre.name }}</td>
                        {% for ech in ctx.obst_sorted_heures %}
                          <td class="echeance-col">
                            {% with val=ctx.obst_obs_data|getV:zone.id|getV:parametre.id|getV:ech.id %}
                                {% if val.1 and "div class" in val.1 %}
                                  {{ val.1 | safe}}
                                {% else %}
                                    <input type="text" name="obs_{{zone.id}}_{{parametre.id}}_{{ech.id}}_{{val.0}}" value="{{ val.1|replace_none:''|safe}}"> 
                                {% endif %}
                            {% endwith %}
                          </td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  {% endfor %}
                  <tr><td colspan="{{ctx.obst_sorted_heures|length|add:'2'}}"><button type="submit" class="btn btn-primary">Enregistrer</button></td></tr>
                </tbody>
            {% else %}
                <tbody>
                  {% for zone in ctx.obst_stations %}
                    {% for parametre in ctx.obst_parameters %}
                      <tr class="{% if forloop.first %}station-separator{% endif %}">
                        {% if forloop.first %}
                          <th rowspan="{{ ctx.obst_parameters|length }}">{{ zone.name }}</th>
                        {% endif %}
                        <td class="parameter-col">{{ parametre.name }}</td>
                        {% for ech in ctx.obst_sorted_heures %}
                          <td class="echeance-col">
                            {% with val=ctx.obst_obs_data|getV:zone.id|getV:parametre.id|getV:ech.id %}
                              {% if val %}
                                {{ val.1|replace_none|safe }}
                              {% else %}
                                -
                              {% endif %}
                            {% endwith %}
                          </td>
                        {% endfor %}
                      </tr>
                    {% endfor %}
                  {% endfor %}
                </tbody>
            {% endif %}
            </table>
    {% else %}

        <table class="forecast-table" style="{{ctx.style.table }}">
            
            <thead>
                 {% if ctx.obst_periode %}<tr>
                    <th colspan="{{ ctx.obst_parameters|length|add:1 }}">Observation : {{ ctx.obst_periode }}</th>
                </tr>{% endif %}
                <tr>
                    <th>Station</th>
                    {% for param in ctx.obst_parameters %}
                            <th> {{ param.name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            {% if modify_text %}  
                <form method="post" action="{% url 'bulletins:save_obsTable' pk=object.id date_bult=object.established_date|date:'Y-m-d' %}" class="bg-light p-4 rounded shadow-sm">
                    {% csrf_token %}
                    <tbody>
                        {% for zone in ctx.obst_stations %}
                        <tr>
                            <td style='font-weight: bold'>{{ zone.name }}</td>
                            {% for parametre in ctx.obst_parameters %}
                                {% for ech in ctx.obst_sorted_heures %}
                                  <td class="echeance-col">
                                    {% with val=ctx.obst_obs_data|getV:zone.id|getV:parametre.id|getV:ech.id %}
                                        {% if val.1 and "div class" in val.1 %}
                                          {{ val.1 | safe}}
                                        {% else %}
                                            <input type="text" name="obs_{{zone.id}}_{{parametre.id}}_{{ech.id}}_{{val.0}}" value="{{ val.1|replace_none:''|safe}}"> 
                                        {% endif %}
                                    {% endwith %}
                                  </td> 
                                {% endfor %}
                            {% endfor %}
                         </tr>
                        {% endfor %}
                        <tr><td colspan="{{ctx.obst_parameters|length|add:'1'}}"><button type="submit" class="btn btn-primary">Enregistrer</button></td></tr>
                    </tbody>
                    
                </form> 
            {% else %}
            <tbody>
                {% for zone in ctx.obst_stations %}
                <tr>
                    <td style='font-weight: bold'>{{ zone.name }}</td>
                    {% for parametre in ctx.obst_parameters %}
                        {% for ech in ctx.obst_sorted_heures %}
                            <td class="{{parametre.name |lower}}">
                                {% with val=ctx.obst_obs_data|getV:zone.id|getV:parametre.id|getV:ech.id %}
                                  {% if val %}
                                    {{ val.1|replace_none|safe }}
                                  {% else %}
                                    -
                                  {% endif %}
                                {% endwith %}
                            </td>
                        {% endfor %}
                    {% endfor %}
                 </tr>
                {% endfor %}
                </tbody>
            {% endif %}
            </table>
        
    {% endif %}
    
</div>
